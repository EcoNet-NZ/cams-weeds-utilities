name: CAMS Spatial Field Updater

on:
  # Scheduled daily run at 6 AM UTC (7 PM NZ Standard Time, 8 PM NZ Daylight Time)
  schedule:
    - cron: '0 6 * * *'
  
  # Manual trigger with configurable options
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run against'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - production
      
      processing_mode:
        description: 'Processing mode'
        required: true
        default: 'changed'
        type: choice
        options:
        - changed
        - all
      
      sample_size:
        description: 'Sample size for testing (leave empty for all records)'
        required: false
        type: string

env:
  PYTHON_VERSION: '3.12'

jobs:
  spatial-field-update:
    name: Update Spatial Fields
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ðŸ—ï¸ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ”§ Configure
        run: |
          ENV=${{ github.event_name == 'schedule' && 'production' || github.event.inputs.environment }}
          echo "ENVIRONMENT=$ENV" >> $GITHUB_ENV
          echo "PROCESSING_MODE=${{ github.event.inputs.processing_mode || 'changed' }}" >> $GITHUB_ENV
          echo "SAMPLE_SIZE=${{ github.event.inputs.sample_size || '' }}" >> $GITHUB_ENV
      
      - name: ðŸŒ Credentials
        env:
          ARCGIS_USERNAME: ${{ env.ENVIRONMENT == 'production' && secrets.ARCGIS_USERNAME_PROD || secrets.ARCGIS_USERNAME_DEV }}
          ARCGIS_PASSWORD: ${{ env.ENVIRONMENT == 'production' && secrets.ARCGIS_PASSWORD_PROD || secrets.ARCGIS_PASSWORD_DEV }}
          ARCGIS_PORTAL_URL: ${{ env.ENVIRONMENT == 'production' && secrets.ARCGIS_PORTAL_URL_PROD || secrets.ARCGIS_PORTAL_URL_DEV }}
        run: |
          echo "ARCGIS_USERNAME=${ARCGIS_USERNAME}" >> $GITHUB_ENV
          echo "ARCGIS_PASSWORD=${ARCGIS_PASSWORD}" >> $GITHUB_ENV
          echo "ARCGIS_PORTAL_URL=${ARCGIS_PORTAL_URL}" >> $GITHUB_ENV
      

      - name: ðŸŽ¯ Process
        id: spatial_update
        run: |
          cd spatial_field_updater
          
          ARGS="--environment ${{ env.ENVIRONMENT }}"
          [ "${{ env.PROCESSING_MODE }}" = "all" ] && ARGS="$ARGS --mode all"
          [ -n "${{ env.SAMPLE_SIZE }}" ] && ARGS="$ARGS --sample-size ${{ env.SAMPLE_SIZE }}"
          
          OUTPUT=$(python spatial_field_updater.py $ARGS 2>&1 | tee /dev/stderr)
          
          UPDATED_COUNT=$(echo "$OUTPUT" | grep -o "Applied [0-9]* updates" | grep -o "[0-9]*" || echo "0")
          UNASSIGNED_REGION=$(echo "$OUTPUT" | grep -o "[0-9]* points remain unassigned.*region" | grep -o "^[0-9]*" || echo "0")
          UNASSIGNED_DISTRICT=$(echo "$OUTPUT" | grep -o "[0-9]* points remain unassigned.*district" | grep -o "^[0-9]*" || echo "0")
          TOTAL_PROCESSED=$(echo "$OUTPUT" | grep -o "Processing [0-9]* weed locations" | grep -o "[0-9]*" || echo "0")
          
          echo "success=true" >> $GITHUB_OUTPUT
          echo "updated_count=$UPDATED_COUNT" >> $GITHUB_OUTPUT
          echo "unassigned_region=$UNASSIGNED_REGION" >> $GITHUB_OUTPUT
          echo "unassigned_district=$UNASSIGNED_DISTRICT" >> $GITHUB_OUTPUT
          echo "total_processed=$TOTAL_PROCESSED" >> $GITHUB_OUTPUT
          
          echo "UPDATED_COUNT=$UPDATED_COUNT" >> $GITHUB_ENV
          echo "UNASSIGNED_REGION=$UNASSIGNED_REGION" >> $GITHUB_ENV
          echo "UNASSIGNED_DISTRICT=$UNASSIGNED_DISTRICT" >> $GITHUB_ENV
          echo "TOTAL_PROCESSED=$TOTAL_PROCESSED" >> $GITHUB_ENV
      

      - name: ðŸ“Š Summary
        if: always()
        run: |
          if [ "${{ steps.spatial_update.outputs.success }}" = "true" ]; then
            STATUS="âœ… Success"
          else
            STATUS="âŒ Failed"
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ“ CAMS Spatial Field Updater
          
          **Status**: $STATUS | **Environment**: ${{ env.ENVIRONMENT }} | **Mode**: ${{ env.PROCESSING_MODE }}
          
          | Metric | Count |
          |--------|--------|
          | ðŸ“ Total Processed | ${{ env.TOTAL_PROCESSED }} |
          | âœï¸ Records Updated | ${{ env.UPDATED_COUNT }} |
          | âš ï¸ Unassigned (Region) | ${{ env.UNASSIGNED_REGION }} |
          | âš ï¸ Unassigned (District) | ${{ env.UNASSIGNED_DISTRICT }} |
          EOF