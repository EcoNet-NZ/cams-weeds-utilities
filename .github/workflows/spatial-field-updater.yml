name: CAMS Spatial Field Updater

on:
  # Scheduled daily run at 6 AM UTC (7 PM NZ Standard Time, 8 PM NZ Daylight Time)
  schedule:
    - cron: '0 6 * * *'
  
  # Manual trigger with configurable options
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run against'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - production
      
      processing_mode:
        description: 'Processing mode'
        required: true
        default: 'changed'
        type: choice
        options:
        - changed
        - all
      
      sample_size:
        description: 'Sample size for testing (leave empty for all records)'
        required: false
        type: string

env:
  PYTHON_VERSION: '3.12'

jobs:
  spatial-field-update:
    name: Update Spatial Fields
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ðŸ—ï¸ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ”§ Configure Environment
        run: |
          # Set environment (default to development for scheduled runs)
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "ENVIRONMENT=development" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          fi
          
          echo "PROCESSING_MODE=${{ github.event.inputs.processing_mode || 'changed' }}" >> $GITHUB_ENV
          echo "SAMPLE_SIZE=${{ github.event.inputs.sample_size || '' }}" >> $GITHUB_ENV
      
      - name: ðŸŒ Set ArcGIS Credentials
        env:
          # Use environment-specific secrets
          ARCGIS_USERNAME: ${{ env.ENVIRONMENT == 'production' && secrets.ARCGIS_USERNAME_PROD || secrets.ARCGIS_USERNAME_DEV }}
          ARCGIS_PASSWORD: ${{ env.ENVIRONMENT == 'production' && secrets.ARCGIS_PASSWORD_PROD || secrets.ARCGIS_PASSWORD_DEV }}
          ARCGIS_PORTAL_URL: ${{ env.ENVIRONMENT == 'production' && secrets.ARCGIS_PORTAL_URL_PROD || secrets.ARCGIS_PORTAL_URL_DEV }}
        run: |
          echo "ARCGIS_USERNAME=${ARCGIS_USERNAME}" >> $GITHUB_ENV
          echo "ARCGIS_PASSWORD=${ARCGIS_PASSWORD}" >> $GITHUB_ENV
          echo "ARCGIS_PORTAL_URL=${ARCGIS_PORTAL_URL}" >> $GITHUB_ENV
      
      - name: ðŸ“… Load Previous Timestamp
        if: env.PROCESSING_MODE == 'changed'
        run: |
          echo "ðŸ” Loading previous timestamp for ${{ env.ENVIRONMENT }} environment..."
          
          # Configure git for potential branch operations
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Try to get timestamp from workflow-state branch
          if git ls-remote --exit-code --heads origin workflow-state > /dev/null 2>&1; then
            echo "ðŸ“¥ Found workflow-state branch, fetching..."
            git fetch origin workflow-state
            
            # Try to get the timestamp file for this environment
            TIMESTAMP_FILE="spatial_field_updater/.last_run_${{ env.ENVIRONMENT }}"
            if git cat-file -e origin/workflow-state:$TIMESTAMP_FILE 2>/dev/null; then
              # Extract timestamp from the branch
              git show origin/workflow-state:$TIMESTAMP_FILE > $TIMESTAMP_FILE
              TIMESTAMP=$(cat $TIMESTAMP_FILE)
              echo "âœ… Loaded previous timestamp: $TIMESTAMP"
              echo "ðŸ“Š Will process records modified since: $TIMESTAMP"
            else
              echo "â„¹ï¸ No previous timestamp found for ${{ env.ENVIRONMENT }} environment"
              echo "ðŸ”„ Will process all records (first run for this environment)"
            fi
          else
            echo "â„¹ï¸ No workflow-state branch found - first run of workflow"
            echo "ðŸ”„ Will process all records"
          fi
      
      - name: ðŸ§ª Validate Configuration
        run: |
          echo "Running validation for environment: ${{ env.ENVIRONMENT }}"
          python -c "
          import json
          import os

          # Check if config file exists
          config_path = 'spatial_field_updater/config/environment_config.json'
          if not os.path.exists(config_path):
              raise FileNotFoundError(f'Configuration file not found: {config_path}')

          # Load and validate configuration
          with open(config_path, 'r') as f:
              config = json.load(f)

          environment = os.environ['ENVIRONMENT']
          if environment not in config:
              raise ValueError(f'Environment \"{environment}\" not found in configuration. Available: {list(config.keys())}')

          env_config = config[environment]
          required_keys = ['weed_locations_layer_id', 'regions_layer_id', 'districts_layer_id']
          
          for key in required_keys:
              if key not in env_config:
                  raise ValueError(f'Missing required configuration key: {key} for environment {environment}')
              if not env_config[key]:
                  raise ValueError(f'Empty configuration value for key: {key} in environment {environment}')

          print(f'âœ… Configuration validation passed for environment: {environment}')
          print(f'ðŸ“ Weed locations layer: {env_config[\"weed_locations_layer_id\"]}')
          print(f'ðŸŒ Regions layer: {env_config[\"regions_layer_id\"]}')
          print(f'ðŸ›ï¸ Districts layer: {env_config[\"districts_layer_id\"]}')
          "
      
      - name: ðŸŽ¯ Run Spatial Field Update
        id: spatial_update
        run: |
          echo "ðŸš€ Starting spatial field update for ${{ env.ENVIRONMENT }} environment..."
          
          cd spatial_field_updater
          
          # Build command arguments
          ARGS="--environment ${{ env.ENVIRONMENT }}"
          
          if [ "${{ env.PROCESSING_MODE }}" = "all" ]; then
            ARGS="$ARGS --mode all"
          fi
          
          if [ -n "${{ env.SAMPLE_SIZE }}" ]; then
            ARGS="$ARGS --sample-size ${{ env.SAMPLE_SIZE }}"
          fi
          
          echo "ðŸ“‹ Running: python spatial_field_updater.py $ARGS"
          
          # Capture output and statistics
          OUTPUT=$(python spatial_field_updater.py $ARGS 2>&1 | tee /dev/stderr)
          
          # Extract statistics from output
          UPDATED_COUNT=$(echo "$OUTPUT" | grep -o "Applied [0-9]* updates" | grep -o "[0-9]*" || echo "0")
          UNASSIGNED_REGION=$(echo "$OUTPUT" | grep -o "[0-9]* points remain unassigned.*region" | grep -o "^[0-9]*" || echo "0")
          UNASSIGNED_DISTRICT=$(echo "$OUTPUT" | grep -o "[0-9]* points remain unassigned.*district" | grep -o "^[0-9]*" || echo "0")
          TOTAL_PROCESSED=$(echo "$OUTPUT" | grep -o "Processing [0-9]* weed locations" | grep -o "[0-9]*" || echo "0")
          
          # Store in outputs and environment
          echo "success=true" >> $GITHUB_OUTPUT
          echo "updated_count=$UPDATED_COUNT" >> $GITHUB_OUTPUT
          echo "unassigned_region=$UNASSIGNED_REGION" >> $GITHUB_OUTPUT
          echo "unassigned_district=$UNASSIGNED_DISTRICT" >> $GITHUB_OUTPUT
          echo "total_processed=$TOTAL_PROCESSED" >> $GITHUB_OUTPUT
          
          echo "UPDATED_COUNT=$UPDATED_COUNT" >> $GITHUB_ENV
          echo "UNASSIGNED_REGION=$UNASSIGNED_REGION" >> $GITHUB_ENV
          echo "UNASSIGNED_DISTRICT=$UNASSIGNED_DISTRICT" >> $GITHUB_ENV
          echo "TOTAL_PROCESSED=$TOTAL_PROCESSED" >> $GITHUB_ENV
          
          echo "âœ… Spatial field update completed successfully"
      
      - name: ðŸ’¾ Store Timestamp in State Branch
        if: steps.spatial_update.outputs.success == 'true'
        run: |
          echo "ðŸ’¾ Storing timestamp for ${{ env.ENVIRONMENT }} environment..."
          
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Get current timestamp (when the processing completed)
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%S)
          echo "ðŸ“… Current timestamp: $TIMESTAMP"
          
          # Check if workflow-state branch exists
          if git ls-remote --exit-code --heads origin workflow-state > /dev/null 2>&1; then
            echo "ðŸ“¥ Checking out existing workflow-state branch"
            git fetch origin workflow-state
            git checkout -b workflow-state origin/workflow-state
          else
            echo "ðŸ†• Creating new workflow-state branch"
            git checkout --orphan workflow-state
            git rm -rf . 2>/dev/null || true
            
            # Create initial README for the state branch
            cat > README.md << 'EOF'
          # Workflow State Branch
          
          This branch stores automated workflow timestamps and state files for the CAMS Spatial Field Updater.
          
          ## Contents
          - `spatial_field_updater/.last_run_development` - Last successful run timestamp for development environment
          - `spatial_field_updater/.last_run_production` - Last successful run timestamp for production environment
          
          ## Purpose
          These timestamps enable incremental processing by tracking when each environment was last processed.
          Only records modified since the last timestamp are processed on subsequent runs.
          EOF
            
            git add README.md
            git commit -m "Initial workflow state branch setup"
          fi
          
          # Create/update timestamp file
          mkdir -p spatial_field_updater
          echo "$TIMESTAMP" > spatial_field_updater/.last_run_${{ env.ENVIRONMENT }}
          
          # Commit and force push (avoids any merge conflicts)
          git add spatial_field_updater/.last_run_${{ env.ENVIRONMENT }}
          git commit -m "chore: update ${{ env.ENVIRONMENT }} timestamp to $TIMESTAMP

          - Workflow: ${{ github.workflow }}
          - Run ID: ${{ github.run_id }}
          - Event: ${{ github.event_name }}
          - Processing Mode: ${{ env.PROCESSING_MODE }}
          - Updated Records: ${{ env.UPDATED_COUNT }}
          - Total Processed: ${{ env.TOTAL_PROCESSED }}"
          
          git push origin workflow-state --force
          
          echo "âœ… Timestamp stored successfully in workflow-state branch"
      
      - name: ðŸ“Š Generate Workflow Summary
        if: always()
        run: |
          echo "ðŸ“Š Generating workflow summary..."
          
          # Determine status
          if [ "${{ steps.spatial_update.outputs.success }}" = "true" ]; then
            STATUS="âœ… Success"
            STATUS_COLOR="ðŸŸ¢"
          else
            STATUS="âŒ Failed"
            STATUS_COLOR="ðŸ”´"
          fi
          
          # Create summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ“ CAMS Spatial Field Updater Results
          
          $STATUS_COLOR **Status**: $STATUS  
          ðŸŒ **Environment**: \`${{ env.ENVIRONMENT }}\`  
          ðŸ”„ **Mode**: \`${{ env.PROCESSING_MODE }}\`  
          ðŸ“… **Run Time**: $(date -u)  
          
          ## ðŸ“Š Processing Statistics
          
          | Metric | Count |
          |--------|--------|
          | ðŸ“ **Total Points Processed** | ${{ env.TOTAL_PROCESSED }} |
          | âœï¸ **Records Updated** | ${{ env.UPDATED_COUNT }} |
          | âš ï¸ **Unassigned (Region)** | ${{ env.UNASSIGNED_REGION }} |
          | âš ï¸ **Unassigned (District)** | ${{ env.UNASSIGNED_DISTRICT }} |
          
          ## ðŸ”— Quick Links
          
          - ðŸ“ˆ [View workflow run details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - ðŸŒ¿ [Workflow state branch](${{ github.server_url }}/${{ github.repository }}/tree/workflow-state)
          - âš™ï¸ [Configuration file](${{ github.server_url }}/${{ github.repository }}/blob/main/spatial_field_updater/config/environment_config.json)
          
          EOF
          
          echo "âœ… Workflow summary generated"